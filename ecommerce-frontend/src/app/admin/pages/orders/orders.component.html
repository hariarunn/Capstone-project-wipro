<section class="max-w-7xl mx-auto px-4 py-8 animate-fade-in" *ngIf="(filtered$ | async) as filtered">
  <div class="mb-5 flex flex-wrap items-center gap-3">
    <h1 class="text-2xl font-bold">Admin · Orders</h1>
    <span class="chip">Operations</span>
    <div class="ml-auto flex gap-2">
      <button class="btn-ghost border border-neutral-200 dark:border-neutral-700" (click)="exportCsv(filtered)">
        Export CSV
      </button>
      <a routerLink="/admin" class="btn-ghost border border-neutral-200 dark:border-neutral-700">Back to Products</a>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4" *ngIf="(stats$ | async) as s">
    <div class="card-base p-4">
      <div class="subtle">Total Orders (filtered)</div>
      <div class="text-2xl font-bold">{{ s.count }}</div>
    </div>
    <div class="card-base p-4">
      <div class="subtle">Revenue (filtered)</div>
      <div class="text-2xl font-bold">₹{{ s.revenue | number }}</div>
    </div>
    <div class="card-base p-4">
      <div class="subtle">Pending</div>
      <div class="text-2xl font-bold">{{ s.pending }}</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card-base p-4 mb-4">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
      <input class="input" [formControl]="q" placeholder="Search by Order ID, name, email" />
      <select class="select" [formControl]="status">
        <option>All</option>
        <option>Created</option>
        <option>Paid</option>
        <option>Dispatched</option>
        <option>Delivered</option>
        <option>Cancelled</option>
      </select>
      <input class="input" type="date" [formControl]="from" />
      <input class="input" type="date" [formControl]="to" />
      <div class="flex items-center gap-2">
        <label class="subtle">Page size</label>
        <select class="select w-24" [formControl]="pageSizeCtrl">
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="20">20</option>
        </select>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Table -->
    <div class="lg:col-span-8 overflow-auto rounded-2xl border border-neutral-200 dark:border-neutral-800">
      <ng-container *ngIf="(paged$ | async) as pageData; else empty">
        <table class="min-w-full text-sm">
          <thead class="bg-neutral-50 dark:bg-neutral-900">
            <tr class="text-left">
              <th class="p-3">Order</th>
              <th class="p-3">Customer</th>
              <th class="p-3 text-right">Amount</th>
              <th class="p-3 text-center">Items</th>
              <th class="p-3 text-center">Status</th>
              <th class="p-3 text-right">Placed</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let o of pageData"
                class="border-t border-neutral-200 dark:border-neutral-800 hover:bg-black/5 dark:hover:bg:white/5 transition-colors cursor-pointer"
                (click)="open(o)">
              <td class="p-3 font-medium">{{ o.id }}</td>
              <td class="p-3">
                <div class="font-medium">{{ userName(o) }}</div>
                <div class="subtle">{{ email(o) }}</div>
              </td>
              <td class="p-3 text-right font-semibold">₹{{ amount(o) | number }}</td>
              <td class="p-3 text-center">{{ totalItems(o) }}</td>
              <td class="p-3 text-center">
                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium"
                      [ngClass]="statusClass(o.status)">{{ o.status }}</span>
              </td>
              <td class="p-3 text-right">
                {{ o.createdAt | date:'medium' }}
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="flex items-center justify-between p-3 border-t border-neutral-200 dark:border-neutral-800">
          <div class="subtle">
            Showing {{ pageData.length }} of {{ filtered.length }} orders
          </div>
          <div class="flex items-center gap-2" *ngIf="(totalPages$ | async) as total">
            <button class="btn-ghost border border-neutral-200 dark:border-neutral-700" (click)="prev(total)">Prev</button>
            <div class="subtle">Page {{ page.value }} of {{ total }}</div>
            <button class="btn-ghost border border-neutral-200 dark:border-neutral-700" (click)="next(total)">Next</button>
          </div>
        </div>
      </ng-container>

      <ng-template #empty>
        <div class="text-center p-10">
          <div class="text-xl font-semibold mb-2">No orders found</div>
          <p class="subtle">Try adjusting filters, or place an order from a user account.</p>
        </div>
      </ng-template>
    </div>

    <!-- Details panel -->
    <div class="lg:col-span-4" *ngIf="selected as s">
      <div class="card-base p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-semibold">Order {{ s.id }}</div>
            <div class="subtle">{{ s.createdAt | date:'medium' }}</div>
          </div>
          <button class="btn-ghost border border-neutral-200 dark:border-neutral-700" (click)="close()">Close</button>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <div>
            <div class="subtle">Customer</div>
            <div class="font-medium">{{ userName(s) }}</div>
            <div class="subtle">{{ email(s) }}</div>
          </div>
          <div class="text-right">
            <div class="subtle">Amount</div>
            <div class="text-xl font-bold">₹{{ amount(s) | number }}</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="subtle mb-2">Shipping</div>
          <div class="rounded-xl p-3 border border-neutral-200 dark:border-neutral-800">
            <div>{{ addressName(s) }}</div>
            <div class="subtle">{{ addressLine(s) }}</div>
            <div class="subtle">{{ addressCityStateZip(s) }}</div>
            <div class="subtle">Phone: {{ addressPhone(s) }}</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="subtle mb-2">Payment</div>
          <div class="rounded-xl p-3 border border-neutral-200 dark:border-neutral-800">
            <div>Method: {{ paymentMethod(s) }}</div>
            <div class="subtle" *ngIf="paymentTxn(s)">Txn: {{ paymentTxn(s) }}</div>
            <div class="subtle" *ngIf="coupon(s)">Coupon: {{ coupon(s) }}</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="subtle mb-2">Items</div>
          <div class="space-y-2">
            <div class="flex items-center gap-3 p-2 rounded-xl border border-neutral-200 dark:border-neutral-800"
                 *ngFor="let it of (s.items || [])">
              <img [src]="it.imageUrl || 'assets/placeholder-product.png'" class="w-12 h-12 rounded-md object-cover" />
              <div class="flex-1">
                <div class="font-medium line-clamp-1">{{ it.title }}</div>
                <div class="subtle">Qty: {{ it.qty }}</div>
              </div>
              <div class="font-semibold">₹{{ (it.price * it.qty) | number }}</div>
            </div>
          </div>
        </div>

        <div class="mt-5">
          <div class="subtle mb-2">Update Status</div>
          <div class="flex flex-wrap gap-2">
            <button class="chip" (click)="setStatus(s,'Created')">Created</button>
            <button class="chip" (click)="setStatus(s,'Paid')">Paid</button>
            <button class="chip" (click)="setStatus(s,'Dispatched')">Dispatched</button>
            <button class="chip" (click)="setStatus(s,'Delivered')">Delivered</button>
            <button class="chip" (click)="setStatus(s,'Cancelled')">Cancelled</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
